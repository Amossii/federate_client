<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <title>
    北邮体育馆  </title>
  <link href='//storage.joyreserve.com/Public/static/library/bootstrap3.3.7/bootstrap.min.css' rel='stylesheet' />
  <link href='//storage.joyreserve.com/Public/static/custom/Admin/Home/my_register.css?date=20191206' rel='stylesheet' />
</head>

<body>
  <header class="header">
    <div class="header-title">
      <div class="col-xs-4">
      </div>
      <div class="col-xs-4">
        <h1 class="title">我的预约</h1>
      </div>
      <div class="col-xs-4">
        <a class="g-header-register_list" href="/index.php/Wechat/Personal/register_list">
          日程表        </a>
      </div>
    </div>
  </header>
  <div class="g-mylist-section">
    <div id="mylist">
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
      <div class="g-list-card g-loading">
        <div class="g-title-loading"><span></span></div>
        <div class="g-card-submit_time-loading"><span></span></div>
        <div class="g-list-label">
          <span></span>
          <span></span>
        </div>
        <hr class="g-card-top-hr">
        <div class="g-card-time-list">
          <div class="g-card-time-item-loading"><span></span></div>
        </div>
        <hr class="g-card-bottom-hr">
        <div class="g-card-button-section">
          <button><span></span></button>
          <button><span></span></button>
          <button><span></span></button>
        </div>
      </div>
    </div>
    <div id='more_div'>
      <button id="more" class="see_more" type="button">
        -- 正在获取，请稍等，请勿返回刷新 --
      </button>
    </div>
    <!doctype html>
<html>

<head>
    <link rel="stylesheet" href="//storage.joyreserve.com/Public/Wechat/css/main.css?date=20190810?date=20190809">
    <link rel="stylesheet" href="//storage.joyreserve.com/Public/static/icon/Wechat/iconfont.css">
</head>

<body>
        <nav class="nav nav-bottom">
        <ul>
            <li>
                <a href="/index.php/Wechat/Show/index">
                    <i class="iconfont icon-dibudaohang-shouye"></i>首页                </a>
            </li>
                        <li>
                <a href="/index.php/Wechat/Home/my_register"><i
                        class="iconfont icon-dibudaohang-wodeyuyue"></i>我的预约</a>
            </li>
            <li>
                <a href="/index.php/Wechat/Show/user"><i
                        class="iconfont icon-dibudaohang-wode"></i>个人中心</a>
            </li>
        </ul>
    </nav>
</body>

<script src="//storage.joyreserve.com/Public/Wechat/js/jquery.min.js"></script>
<script src="//storage.joyreserve.com/Public/assets_1/js/jquery.cookie.js"></script>

<script type="text/javascript">

    /**
     * 暂未添加自动判定语言
     * @param  {[type]} ) {                               } [description]
     * @return {[type]}   [description]
     */
    $(document).ready(function () {

        // 根据语言自动跳转
        // auto_jump_by_lang();

    });


    /**
     * 根据语言自动跳转
     * @return {[type]} [description]
     */
    function auto_jump_by_lang() {

        // url中是否已经存在语言变量且有值
        var now_lang = getParam('l');
        console.log(now_lang);

        // 如果没有，则跳转
        if (!now_lang) {


            if ($.cookie('lang')) {
                // alert($.cookie('lang'));
                now_lang = $.cookie('lang');
            }
            else {

                // 从浏览器获取
                var type = navigator.appName;
                if (type == "Netscape") {
                    var lang = navigator.language;
                }
                else {
                    var lang = navigator.userLanguage;
                }

                // 取得浏览器语言的前两个字母
                now_lang = lang.substr(0, 2);

            }

            console.log($.cookie('lang'));

            // 英语
            if (now_lang == "en") {
                $.cookie('lang', now_lang); //设置cookie的值
                window.location.href = "?l=en-us";
            }
            // 中文 - 不分繁体和简体
            else if (now_lang == "zh") {
                $.cookie('lang', now_lang); //设置cookie的值
                window.location.href = "?l=zh-cn";

            }
            // 除上面所列的语言
            else {
                $.cookie('lang', now_lang); //设置cookie的值
                window.location.href = "?l=en-us";
            }


        }

    }


    /**
     * 获取指定的URL参数值
     * URL:http://www.quwan.com/index?name=tyler
     * 参数：paramName URL参数
     * 调用方法:getParam("name")
     * 返回值:tyler
     */
    function getParam(paramName) {
        paramValue = "", isFound = !1;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
            while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
        }
        return paramValue == "" && (paramValue = null), paramValue
    }


</script>


<!--//分享用的代码-->
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>
    // 判断http或者https
    protocol = document.location.protocol;

    // --------------------微信API------------------------------ //
    var objectModel = {};
    objectModel['url'] = window.location.href;  // 此网址必须是当前页面的网址，需要传递的网址不能带&等参数，只能是这种http://www.joyreserve.com/index.php/Wechat/Conference/conference_share/reservation_id/49110/reserve_system_id/1

    console.log(objectModel);
    $.ajax({
        cache: false,
        type: "POST",
        url: "/index.php/Wechat/Conference/getWxSign", // 共用会议分享的接口
        dataType: "json",
        data: objectModel,
        timeout: 30000,

        error: function (e) {
            // alert("微信接口错误");
            console.log("微信接口错误");
        },
        success: function (data) {
            console.log(data);
            wx.config({
                debug: false,
                appId: data['appId'],
                timestamp: data['timestamp'],
                nonceStr: data['nonceStr'],
                signature: data['signature'],
                jsApiList: [
                    'onMenuShareTimeline',
                    'onMenuShareAppMessage'// 所有要调用的 API 都要加到这个列表中
                ]
            });
        }
    });

    var to_share_page_url = protocol + '//' + document.domain + "/index.php/1600";
    console.log(to_share_page_url);

    // 但用户分享时创建的记录所需数据

    wx.ready(function () {
        // 在这里调用 API
        var share = {};
        share['title'] = "北邮体育馆 ";
        share['content'] = "赶快预约吧";

        wx.onMenuShareTimeline({
            title: share['title'], // 分享标题
            desc: share['content'],
            link: to_share_page_url, // 分享链接
            imgUrl: "//storage.joyreserve.com/Public/Wechat/img/ReserveWechat.jpg",
            success: function () {
                // 用户确认分享后执行的回调函数


            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }

        });

        wx.onMenuShareAppMessage({
            title: share['title'], // 分享标题
            desc: share['content'],
            link: to_share_page_url, // 分享链接
            imgUrl: "//storage.joyreserve.com/Public/Wechat/img/ReserveWechat.jpg",
            success: function () {
                // 用户确认分享后执行的回调函数

            },
            cancel: function () {
                // 用户取消分享后执行的回调函数
            }
        });


    });
</script>

</html>

    <!-- 所有页面都共享confirm提示框 start-->
    <div id="w-error-popup-white" style="display: none;" class="w-error-popup-white">
      <div class="w-error-back">
      </div>
      <div class="w-error-inner">
        <div id="w-confirm-content" class="w-error-content" style="height: auto; font-size: 26px;">
          取消后不能恢复，确定取消么？
        </div>
        <div class="btn" style="width:100%; padding: 1rem; text-align: right;">
          <a class="u-btn u-btn-red" href="javascript:canclePopup();">取消</a>
          <a id="sure" class="u-btn" href="javascript:sure();">确定</a>
        </div>
      </div>
    </div>
    <!-- 所有页面都共享confirm提示框 end-->

    <!-- 所有页面都共享alert提示框 start-->
    <div id="w-alert-popup-white" style="display: none;" class="w-error-popup-white">
      <div class="w-error-back">
      </div>
      <div class="w-error-inner">
        <div id="w-alert-content" class="w-error-content" style="height: auto; font-size: 26px;">
          这是提示内容
        </div>
        <div class="btn" style="width:100%; padding: 1rem; text-align: right;">
          <a class="u-btn u-btn-red" href="javascript:alertHide();">确定</a>
        </div>
      </div>
    </div>
    <!-- 所有页面都共享alert提示框 end-->
</body>


<input type="hidden" id="reserve_system_id" value="1593">
<input type="hidden" id="is_not_open_comments" value="">

<!--是否开启签退功能 -->
<input type="hidden" id='is_open_sign_out'
  value="0" />

<!--是否开启 订单反馈 -->
<input type="hidden" id="basic_is_use_feedback"
  value="0">


<!-- 是否开启 多级审核-->
<input type="hidden" id="is_active_multi_level_approve"
  value="0" />

<script src="//storage.joyreserve.com/Public/static/library/jquery3.4.1/jquery.min.js"></script>
<script src="//storage.joyreserve.com/Public/static/library/bootstrap3.3.7/bootstrap.min.js"></script>
<script src="//storage.joyreserve.com/Public/Wechat/js/index.js"></script>
<script src="//storage.joyreserve.com/Public/static/js/login.js"></script>
<script type="text/javascript">
  var reserve_system_id = $("#reserve_system_id").val()
  var is_active_multi_level_approve = $('#is_active_multi_level_approve').val()
  var is_open_sign_out = parseInt($('#is_open_sign_out').val())// 是否开启签退功能
  var basic_is_use_feedback = parseInt($('#basic_is_use_feedback').val()) //判断是否开启订单反馈
  var is_not_open_comments = parseInt($('#is_not_open_comments').val())//判断系统是否打开发表评价
  var timeMoreState = []
  var pageNum = 1
  var isLoad = true

  //main
  $(function () {
    var login = new Login("Alex", { initShow: true })
    $(".g-mylist-section").height($(window).height() - 85)
    getList(pageNum).then(function (data) {
      $("#mylist").html("")
      $(".g-mylist-section").css("overflow", "auto")
      setList(data)
      $(".g-card-button-section").css("margin-left", "-20px")
      reloadList()
    })

    $("#more").click(handleClickMore)

    $(window).on("touchend", function () {
      var time = setInterval(function () {
        if (isLoad && $("#more").offset().top < ($(window).height() - 50)) {
          isLoad = false
          handleClickMore()
        }
      }, 100);
      setTimeout(function () {
        isLoad = true
        clearInterval(time)
      }, 1000);
    })
  });

  //触发加载更多方法
  function handleClickMore() {
    $('#more').html('-- 加载中 --')
    getList(pageNum).then(function (data) {
      setList(data)
      $(".g-card-button-section").css("margin-left", "-20px")
    })
  }

  //渲染列表方法
  function setList(data) {
    $("#mylist").append(setListHTML(data))
    $('#more').html('-- 查看更多 --')
    $(".g-card-button-section").css("margin-left", "-20px")
    pageNum++
  }

  //定时刷新页面方法
  function reloadList() {
    setTimeout(function () {
      getList(1).then(function (data) {
        data.data.forEach(function (item) {
          $(`#cg-list-card-${item.id}`).remove()
        })
        $("#mylist").prepend(setListHTML(data))
        $(".g-card-button-section").css("margin-left", "-20px")
        reloadList()
      })
    }, 20000)
  }

  //渲染列表模板
  function setListHTML(data) {
    if (data.error_id !== 0) {
      alert(data.message)
      return
    }
    if (!data.data || !data.data.length) {
      $("#more_div").html('<div style="text-align:center"><h5>无更多数据</h5></div>')
      $("#more").hide()
      return
    }
    var configure = data.conf
    var result = data.data.map(function (item) {
      var state = handleStateLabel(item.state)
      var payState = handlePayStateLabel(item.total_amount, item.pay_status)
      var isOpen = timeMoreState.find(function (id) {
        if (id.toString() === item.id.toString()) {
          return true
        }
      })
      return `
                <div class="g-list-card" id="cg-list-card-${item.id}">
                    <h1 class="g-card-name">${item.classroom_name}</h1>
                    <p class="g-card-submit_time">下单时间:${item.submit_time} ${item.id}</p>
                    <div class="g-list-label">
                        <p style="color:${state.labelType};">${state.text}</p>
                        <p style="color:${payState.labelType}; margin-top:8px;">${payState.text}</p> 
                    </div>
                    <hr class="g-card-top-hr">
                        <div style="${isOpen ? "max-height:1000px" : "max-height:75px"}" id="cg-card-time-list-${item.id}" class="g-card-time-list">
                            ${setTimeList(item.reserve_times, configure)}
                        </div>
                        ${item.reserve_times.length > 2 ? `
                        <p id="cg-card-time-more-${item.id}" class="g-card-time-more${isOpen ? "-open" : ""}" 
                        onclick="handleClickTimeMore(${item.id},${item.reserve_times.length})">${isOpen ? "点击收起" : "... ..."}</p>` : ""}
                        ${item.state === 10 ? `<div class="submit_time">签退时间:${item.cancel_timestamp}</div>` : ""}
                        ${item.state >= 3 && item.state <= 6 ? `<div class="g-card-time-item" style="color:#999">取消时间:${item.cancel_timestamp}</div>` : ""}
                        <hr class="g-card-bottom-hr"/>
                        ${item.admin_comment ? `
                        <div class="description">
                            管理员留言:${item.admin_comment}
                        </div>`: ""}
                        ${item.admin_score > 0 ? `
                        <div class="description">
                            评分:${item.admin_score}
                        </div>`: ""}
                    <div class="g-card-button-section">
                        ${setListButton(item, configure)}
                    </div>
                </div>`
    }).join("")
    return result
  }

  //渲染列表状态
  function handleStateLabel(stateValue) {
    var result = { labelType: "", text: "" }
    switch (parseInt(stateValue)) {
      case 0:
        result.labelType = "#f0ad4e"
        result.text = parseInt(is_active_multi_level_approve) > 0 ? "等待上级管理员一次审核" : "审核中"
        break
      case 1:
        result.labelType = "#8bc348"
        result.text = "已批准"
        break
      case 2:
        result.labelType = ""
        result.text = "未通过"
        break
      case 3:
        result.labelType = ""
        result.text = "已取消"
        break
      case 4:
        result.labelType = "#d9534f"
        result.text = "退款中"
        break
      case 5:
        result.labelType = "#d9534f"
        result.text = "已退款"
        break
      case 6:
        result.labelType = "#d9534f"
        result.text = "退款被拒绝"
        break
      case 7:
        result.labelType = "#d9534f"
        result.text = "等待上级管理员二次审核"
        break
      case 8:
        result.labelType = "#d9534f"
        result.text = "等待上级管理员三次审核"
        break
      case 9:
        result.labelType = "#d9534f"
        result.text = "排队中"
        break
      case 10:
        result.labelType = ""
        result.text = "已签退"
        break
    }
    return result
  }

  //渲染列表支付状态
  function handlePayStateLabel(totalAmount, payState) {
    var result = { labelType: "", text: "" }
    //if (totalAmount <= 0) {
    //  result.labelType = "#8bc348"
    //  result.text = ""
    //  return result
    //}
  
    switch (parseInt(payState)) {
      case 1:
        result.labelType = "#d9534f"
        result.text = "未支付"
        break
      case 2:
        result.labelType = "#8bc348"
        result.text = "已微信支付"
        break
      case 3:
        result.labelType = "#8bc348"
        result.text = "已余额支付"
        break
      case 4:
        result.labelType = "#8bc348"
        result.text = "已套餐支付"
        break
      case 5:
        result.labelType = "#8bc348"
        result.text = "已支付宝支付"
        break
      case 7:
        result.labelType = "#8bc348"
        result.text = "已Visa|Master|eNets支付"
        break
    }
  
    return result
  }

  //渲染列表时间列表
  function setTimeList(data, configure) {
    var result = ""
    if (!data || !data.length) {
      result = '<div class="reserve_time"> </div>'
      return result
    }
    result = data.map(function (item) {
      var week = ""
      switch (parseInt(item.time.weekday)) {
        case 1: week = '一'; break
        case 2: week = '二'; break
        case 3: week = '三'; break
        case 4: week = '四'; break
        case 5: week = '五'; break
        case 6: week = '六'; break
        case 7: week = '日'; break
        case 0: week = '日'; break
      }

      return `
                <p class="g-card-time-item">
                    ${item.time.date} 周${week} ${item.time.lesson}
                    ${item.tag ? item.tag : ""}
                    ${configure.is_show_sign_state === "1" ?
          parseInt(item.is_attend) === 1 ?
            `<span class="g-card-time-label" style="color:#8bc348;">签到成功</span>${item.time.number}号` :
            '<span class="g-card-time-label" style="color:#f0ad4e;">未签到</span>' : ""}
                    ${parseInt(configure.is_active_sequence_number) === 1 || parseInt(configure.is_active_sequence_number) === 2 || parseInt(configure.is_active_sequence_number) === 3 ?
          `<span>序号${item.sequence_number}</span>` : ""}
                </p>
            `
    }).join("")
    return result
  }

  //渲染列表模板按钮
  function setListButton(data, configure) {

    var isPast = true

    if (data.reserve_times && data.reserve_times.length) {
      const timeStamp = Math.round(new Date() / 1000)
      if (data.reserve_times[0].time.start_timestamp < timeStamp) {
        isPast = false
      }
    }

    function template(className, text, event) {
      return `<button class="${className}" onclick="${event}">${text} </button>`
    }

    var result = template("", "查看详情", `detail(${data.id})`)

    if (parseInt(data.state) < 2 || parseInt(data.state) > 6) {
      if (is_open_sign_out === 1 && parseInt(data.can_sign_out) === 1 && parseInt(data.state) === 1) {
        result += template("", "签退", `sign_out(${data.id})`)
      } else {
        switch (parseInt(data.comment_state)) {
          case 0:
            isPast ? result += template("g-card-button-or", "取消预约", `cancel(${data.id})`) : null
            break
          case 1:
            if (parseInt(data.is_expired) === 1 || parseInt(data.state === 10)) {
              if (basic_is_use_feedback === 1 && !data.used_feedback) {
                result += template("", "订单反馈", `feedback(${data.id})`)
              }
              if (!is_not_open_comments) {
                result += template("", "发表评价", `comment(${data.id})`)
              }
            } else {
              isPast ? result += template("g-card-button-or", "取消预约", `cancel(${data.id})`) : null
            }
            break
          default: result += template("", "查看评价", `comment(${data.id})`)
        }
      }
    }

    // 是否需要开门按钮（开启了门禁+尚未过期+订单已通过）
    if (parseInt(configure.is_use_door_control_hardware) === 5 && parseInt(data.is_expired) !== 1 && parseInt(data.state) === 1) {
      /** 垠坤门禁 start */
      result += `<div style = "font-size: 14px;padding: 3px 0;border-radius: 15px;margin-top: 10px;float: right;margin-left: 10px;">
        开门码：${data.open_door_code}
        </div>`
      result += template("", "开门", `open_door_by_code(${data.classroom_id},${data.open_door_code})`)
      /** 垠坤门禁 end */
    }

    if (parseInt(configure.order_verification_config) === 1 && parseInt(data.state) === 1) {
      result += template("", "预约码", `verification(${data.id})`)
    }
    return result
  }

  //处理点击列表时间列表展开方法
  function handleClickTimeMore(id, length) {
    if ($(`#cg-card-time-list-${id}`).height() > 75) {
      timeMoreState.splice(timeMoreState.findIndex(function (item) {
        return item.toString() === id.toString()
      }), 1)
      $(`#cg-card-time-list-${id}`).animate({ maxHeight: "75px" }, null, null, function () {
        $(`#cg-card-time-more-${id}`).attr("class", "g-card-time-more")
        $(`#cg-card-time-more-${id}`).text("... ...")
      })
    } else {
      timeMoreState.push(id)
      $(`#cg-card-time-list-${id}`).animate({ maxHeight: `${37 * length}px` }, null, null, function () {
        $(`#cg-card-time-more-${id}`).attr("class", "g-card-time-more-open")
        $(`#cg-card-time-more-${id}`).text("点击收起")
      })
    }
  }

  //请求列表方法
  function getList(pageNum) {
    var url = "/index.php/Wechat/Home/my_register_more?pagenum=" + pageNum;
    var promise = new Promise(function (resolve, reject) {
      $.ajax({
        url,
        method: "GET",
        dataType: "json",
        success: function (data) {
          if (data && !data.error_id) {
            resolve(data)
          } else {
            reject(data.message)
          }
        },
        error: function () {
          reject("连接失败，请检查网络情况")
        }
      })
    })
    return promise
  }

  //订单反馈
  function feedback(order_id) {
    window.location.href = "/index.php/Wechat/Home/edit_feedback_prompt?reservation_id=" + order_id;
  }

  //确定取消预约前询问
  function cancel(order_id) {
    // 设置文字
    $("#w-confirm-content").html("是否要取消预约?");
    // 设置确认之后操作函数
    $('#sure').attr('href', 'javascript:cance_agree(' + order_id + ');');
    // 展示
    $("#w-error-popup-white").show();
  }

  /**
   * 同意取消之后回调函数
   * @param  {[type]} order_id [description]
   * @return {[type]}          [description]
   */
  function cance_agree(order_id) {
    window.location.href = "/index.php/Wechat/Home/register_cancel?reservation_id=" + order_id;
  }

  //点击查看详情
  function detail(order_id) {
    window.location.href = "/index.php/Wechat/Home/register_detail?reservation_id=" + order_id;
  }

  //点击评价订单
  function comment(order_id) {
    window.location.href = "/index.php/Wechat/Home/comment?reservation_id=" + order_id;
  }

  //点击出现核销二维码
  function verification(order_id) {
    window.location.href = "/index.php/Wechat/Home/verification?reservation_id=" + order_id;
  }

  //点击签退
  function sign_out(order_id) {
    // 设置文字
    $("#w-confirm-content").html('是否确认签退');
    // 设置确认之后操作函数
    $('#sure').attr('href', 'javascript:sign_out_surely(' + order_id + ');');
    // 展示
    $("#w-error-popup-white").show();
  }

  // 确认签退
  function sign_out_surely(order_id) {
    window.location.href = "/index.php/Wechat/Home/sign_out?reservation_id=" + order_id;
  }

  //发起会议
  function conference(order_id) {
    window.location.href = "/index.php/Wechat/Conference/conference/reservation_id/" + order_id + '/reserve_system_id/' + reserve_system_id;
  }

  // 会议详情
  function conference_detail(order_id) {
    window.location.href = "/index.php/Wechat/Conference/conference_share/reservation_id/" + order_id + '/reserve_system_id/' + reserve_system_id;
  }

  // 得到域名
  function getDomain() {
    var domain = document.domain;
    if (domain === 'localhost') {
      //TODO: 这里需要根据实际情况进行修改
      /*domain+='/weixin';*/
      domain += '/reserve/1';
    }
    return domain;
  }

  function sure() {
    $("#w-error-popup-white").hide();
    alert("确定");
  }

  function canclePopup() {
    $("#w-error-popup-white").hide();
  }

  function alertHide() {
    $("#w-alert-popup-white").hide();
  }

  function confirmClickMethed() {
    $("#w-confirm-content").html("这是一个confirm内容，取消还是确认呢？");
    $("#w-error-popup-white").show();
  }

  function alertClickMethed() {
    $("#w-alert-content").html("这是一个alert内容");
    $("#w-alert-popup-white").show();
  }

  /**
   * 远程开门
   * @return {[type]} [description]
   */
  function open_door_by_code(room_id, code) {
    // 判断http或者https
    protocol = document.location.protocol;
    var url = '';
    if (document.domain === 'localhost') {
      url = protocol + '//' + document.domain + '/' + location.pathname.split('/', 2)[1] + '/1/index.php/API/DoorLockYinkun/';
    } else {
      url = protocol + '//' + document.domain + '/index.php/API/DoorLockYinkun/';
    }
    sendData = {};
    sendData['reserve_system_id'] = $('#reserve_system_id').val();
    sendData['room_id'] = room_id;
    sendData['code'] = code;
    $("#w-alert-content").html("请稍等！");
    $("#w-alert-popup-white").show();
    //API接口地址
    $.ajax({
      url: url + 'ajax_open_door_by_code',
      cache: false,
      data: sendData,
      dataType: "json",
      type: "GET",
      error: function (e) {
        console.log('未获取数据，请联系管理员，请求错误');
      },
      success: function (data) {
        // console.log(data);
        if (data['err_no'] === 0) {
          $("#w-alert-content").html("开锁成功！");
        } else if (data['err_no'] === 4) {
          $("#w-alert-content").html("开锁失败，请重试！");
        } else {
          $("#w-alert-content").html("您预约的时间段未到，请在预约的时间段内使用！");
        }
      }
    });
  }
</script>

</html>